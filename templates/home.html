{% extends 'base.html' %} {% block content %}
<div class="container-lg min-vh-100 my-3">
  <div class="row">
    <div class="col-sm-7">
      <div class="border rounded p-2" style="width: 100%; height: auto">
        <div
          class="d-flex justify-content-between align-items-center border-bottom pb-4"
        >
          <div>
            <input
              editing
              class="mr-1"
              type="text"
              style="width: 100px; min-width: 100px"
              value="Name"
              oninput="adjustWidth(this)"
            />
            <span type="button" onclick="focusInput(this)"
              ><i class="fas fa-pen"></i
            ></span>
          </div>
          <span
            class="text-primary"
            type="button"
            class="dropdown-toggle"
            data-toggle="dropdown"
          >
            <span type="button" class="p-2">
              <i class="fas fa-ellipsis-v"></i
            ></span>
            <div class="dropdown-menu dropdown-menu-right">
              <a class="dropdown-item" href="#">Delete class</a>
              <a class="dropdown-item" href="#">Disable class</a>
              <a class="dropdown-item" href="#">Remove All Samples</a>
              <a class="dropdown-item" href="#">Download Samples</a>
            </div>
          </span>
        </div>
        <div>
          <div class="sample-input-list mt-1">
            <h6><i>Add Image Samples:</i></h6>
            <div class="d-flex justify-content-start align-items-center">
              <button
                type="button"
                class="btn-show-webcam btn btn-outline-primary mr-2 d-flex flex-column justify-content-between align-items-center"
              >
                <i class="fas fa-video"></i>
                <span>Webcam</span>
              </button>
              <button
                type="button"
                class="btn btn-outline-primary p-2 d-flex flex-column justify-content-between align-items-center"
              >
                <i class="fas fa-upload"></i>
                <span>Upload</span>
              </button>
            </div>
          </div>
          <div class="open-container position-relative">
            <div style="width: 50%">
              <button
                class="btn position-absolute top-0"
                style="right: 50%; z-index: 1"
                onclick="closeContainer()"
              >
                X
              </button>

              <div>
                <video
                  id="webcam"
                  autoplay
                  playsinline
                  style="width: 100%"
                ></video>
                <br />
                <canvas id="canvas" width="260" height="260"></canvas>
                <button
                  id="flipButton"
                  class="position-absolute top-0"
                  style="left: 0"
                  onclick="flip()"
                >
                  Flip Camera
                </button>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  style="width: 75%"
                  onclick="Add()"
                >
                  Hold to Record
                </button>
                <button type="button" class="btn btn-outline-primary border-0">
                  <i class="fas fa-cog"></i>
                </button>
              </div>
            </div>
            <div style="width: 50%">
              <div id="open-samples-label" class="samples-label">
                0 Image Samples
              </div>
              <div class="inner-samples-container">
                <div class="samples" style=""></div>
              </div>
            </div>
          </div>

          <div class="samples-container"></div>
        </div>
      </div>
    </div>
    <div class="col-sm-2"></div>
    <div class="col-sm-4"></div>
  </div>
</div>
<script>
  var sample_input_list = $(".sample-input-list");
  var openContainer = $(".open-container");
  $(".btn-show-webcam").on("click", () => {
    sample_input_list.hide();
    openContainer.css("display", "flex");
    startWebCam();
  });

  var list_images = [];
  function shortcut() {
    var picture = webcam.snap();
    // list_images.push(picture);
    return picture;
  }
  function Add() {
    list_images.push(shortcut());
    var html = convertListToElement();
    $(".samples").html(html);
  }
  function convertListToElement() {
    var html = "";
    list_images.forEach((value, index) => {
      html += `<img class='samples_image' src=${value} alt=''/>`;
    });
    return html;
  }
  function closeContainer() {
    sample_input_list.show();
    openContainer.css("display", "none");
    stopWebCam();
  }
  function focusInput(ele) {
    $(ele).siblings("input").focus();
  }
  function adjustWidth(input) {
    // Reset input width to auto to allow it to expand
    // input.style.width = 'auto';
    // Calculate the width required to fit the content
    var width = input.scrollWidth;
    if (width <= 100) return;
    // Set the input width to the calculated width
    input.style.width = width + "px";
  }
  var video = document.getElementById("videoElement");

  var stream;
  const webcamElement = document.getElementById("webcam");
  const canvasElement = document.getElementById("canvas");
  const webcam = new Webcam(webcamElement, "user", canvasElement);

  function flipCamera() {
    if (webcamElement.style.transform === "scaleX(1)") {
      video.style.transform = "scaleX(-1)";
    } else {
      video.style.transform = "scaleX(1)";
    }
  }
  function flip() {
    webcam.flip();
  }
  function startWebCam() {
      webcam
        .start()
        .then((result) => {
          const canvas = document.querySelector("canvas");
          const ctx = canvas.getContext("2d");
          const video = document.querySelector("video");
          video.addEventListener("play", () => {
            function step() {
              // Lấy kích thước của video
              const videoWidth = video.videoWidth;
              const videoHeight = video.videoHeight;

              // Tính toán kích thước hình vuông
              const size = Math.min(videoWidth, videoHeight);

              // Tính toán vị trí để cắt video theo chiều ngang giữa để tạo thành hình vuông
              const offsetX = (videoWidth - size) / 2;
              const offsetY = (videoHeight - size) / 2;

              // Cắt video chỉ lấy hình vuông
              ctx.drawImage(
                video,
                offsetX,
                offsetY,
                size,
                size,
                0,
                0,
                canvas.width,
                canvas.height
              );

            // Gọi lại hàm này để vẽ tiếp mỗi frame của video
            requestAnimationFrame(step);
          }

          // Bắt đầu vẽ video lên canvas
          step();
        });
      })
      .catch((err) => {
        console.log(err);
      });
  }
  function stopWebCam() {
    webcam.stop();
  }
</script>

{% endblock %}
